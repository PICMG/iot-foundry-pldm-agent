{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://iot-foundry.io/schemas/pldm-agent-config.json",
  "title": "PLDM Agent Configuration",
  "description": "Configuration schema for the IoT-Foundry PLDM Agent",
  "type": "object",
  "required": ["agent", "downstream_transport", "logging"],
  "properties": {
    "agent": {
      "type": "object",
      "description": "Core agent configuration",
      "required": ["name", "enabled"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Name identifier for this agent instance",
          "minLength": 1
        },
        "enabled": {
          "type": "boolean",
          "description": "Whether the agent is enabled on startup"
        },
        "instanceId": {
          "type": "integer",
          "description": "PLDM instance ID (0-31)",
          "minimum": 0,
          "maximum": 31,
          "default": 0
        },
        "role": {
          "type": "string",
          "enum": ["requester", "responder", "both"],
          "description": "Agent role in PLDM communication",
          "default": "both"
        }
      }
    },
    "downstream_transport": {
      "type": "object",
      "description": "Downstream PLDM transport via MCTP serial (PTY or physical serial device)",
      "required": ["mctp_interface", "local_eid", "peer_eids"],
      "properties": {
        "mctp_interface": {
          "type": "string",
          "description": "MCTP serial interface name assigned by Linux (e.g., 'mctpserial0')",
          "minLength": 1
        },
        "local_eid": {
          "type": "integer",
          "description": "Local MCTP Endpoint ID for this agent",
          "minimum": 8,
          "maximum": 255
        },
        "peer_eids": {
          "type": "array",
          "description": "List of remote endpoint IDs to communicate with",
          "items": {
            "type": "integer",
            "minimum": 8,
            "maximum": 255
          },
          "minItems": 1
        },
        "serial_device": {
          "type": ["string", "null"],
          "description": "Physical serial device path (e.g., '/dev/ttyUSB0'). If null, uses PTY (pseudo-terminal)",
          "default": null
        },
        "baud_rate": {
          "type": ["integer", "null"],
          "description": "Serial baud rate (only used if serial_device is specified)",
          "enum": [null, 9600, 19200, 38400, 57600, 115200, 230400, 460800, 921600],
          "default": null
        },
        "enable_diagnostics": {
          "type": "boolean",
          "description": "Enable libsermctp diagnostic output for debugging MCTP communication",
          "default": false
        },
        "timeout_ms": {
          "type": "integer",
          "description": "Request timeout in milliseconds",
          "minimum": 100,
          "default": 5000
        },
        "retries": {
          "type": "integer",
          "description": "Number of retry attempts on request failure",
          "minimum": 0,
          "maximum": 10,
          "default": 3
        },
        "retry_delay_ms": {
          "type": "integer",
          "description": "Delay between retry attempts in milliseconds",
          "minimum": 0,
          "default": 1000
        },
        "max_concurrent": {
          "type": "integer",
          "description": "Maximum concurrent PLDM requests",
          "minimum": 1,
          "default": 10
        },
        "supported_types": {
          "type": "array",
          "description": "Supported PLDM message types",
          "items": {
            "type": "string",
            "enum": [
              "base",
              "platform",
              "bios",
              "fru",
              "firmware-update",
              "redfish-device-enablement",
              "oem"
            ]
          },
          "default": ["base", "platform"]
        }
      }
    },
    "messaging": {
      "type": "object",
      "description": "PLDM messaging configuration",
      "properties": {
        "timeout": {
          "type": "integer",
          "description": "Request timeout in milliseconds",
          "minimum": 100,
          "default": 5000
        },
        "retries": {
          "type": "integer",
          "description": "Number of retry attempts",
          "minimum": 0,
          "maximum": 10,
          "default": 3
        },
        "retryDelay": {
          "type": "integer",
          "description": "Delay between retries in milliseconds",
          "minimum": 0,
          "default": 1000
        },
        "maxConcurrent": {
          "type": "integer",
          "description": "Maximum concurrent PLDM requests",
          "minimum": 1,
          "default": 10
        },
        "supportedTypes": {
          "type": "array",
          "description": "Supported PLDM message types",
          "items": {
            "type": "string",
            "enum": [
              "base",
              "platform",
              "bios",
              "fru",
              "firmware-update",
              "redfish-device-enablement",
              "oem"
            ]
          },
          "default": ["base", "platform"]
        }
      }
    },
    "endpoints": {
      "type": "array",
      "description": "PLDM endpoints to communicate with",
      "items": {
        "type": "object",
        "required": ["eid", "enabled", "initialize"],
        "properties": {
          "eid": {
            "type": "integer",
            "description": "MCTP Endpoint ID",
            "minimum": 8,
            "maximum": 255
          },
          "name": {
            "type": "string",
            "description": "Friendly name for the endpoint"
          },
          "enabled": {
            "type": "boolean",
            "description": "Whether to communicate with this endpoint",
            "default": true
          },
          "initialize": {
            "type": "boolean",
            "description": "Whether the agent should initialize this endpoint (true) or if it's pre-initialized by the system (false)"
          },
          "hw_address": {
            "type": "string",
            "description": "USB hardware address for consistent binding to physical USB port (e.g., '1-1.2:1.0'). Mutually exclusive with serial_device. Recommended for USB-serial devices."
          },
          "serial_device": {
            "type": "string",
            "description": "Direct serial device path (e.g., '/dev/ttyUSB0', '/dev/ttyS1'). Mutually exclusive with hw_address. Use for non-USB serial ports."
          },
          "baud_rate": {
            "type": "integer",
            "description": "Serial baud rate (required if initialize=true)",
            "enum": [9600, 19200, 38400, 57600, 115200, 230400, 460800, 921600]
          },
          "flow_control": {
            "type": "string",
            "description": "Hardware flow control setting (required if initialize=true)",
            "enum": ["none", "hardware", "software"]
          },
          "connector_id": {
            "type": "string",
            "description": "Physical connector identifier/label (e.g., 'J12', 'CON3') for physical hardware documentation (required if initialize=true)"
          },
          "poll": {
            "type": "boolean",
            "description": "Enable periodic polling",
            "default": false
          },
          "poll_interval": {
            "type": "integer",
            "description": "Polling interval in seconds",
            "minimum": 1,
            "default": 60
          }
        },
        "allOf": [
          {
            "if": {
              "properties": { "initialize": { "const": true } }
            },
            "then": {
              "required": ["baud_rate", "flow_control", "connector_id"],
              "oneOf": [
                { "required": ["hw_address"] },
                { "required": ["serial_device"] }
              ]
            }
          }
        ]
      }
    },
    "discovery": {
      "type": "object",
      "description": "Endpoint discovery configuration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable automatic endpoint discovery",
          "default": true
        },
        "interval": {
          "type": "integer",
          "description": "Discovery interval in seconds",
          "minimum": 10,
          "default": 300
        },
        "eidRange": {
          "type": "object",
          "description": "EID range to scan",
          "properties": {
            "start": {
              "type": "integer",
              "minimum": 8,
              "maximum": 254,
              "default": 8
            },
            "end": {
              "type": "integer",
              "minimum": 8,
              "maximum": 254,
              "default": 254
            }
          }
        }
      }
    },
    "logging": {
      "type": "object",
      "description": "Logging configuration",
      "required": ["level"],
      "properties": {
        "level": {
          "type": "string",
          "enum": ["debug", "info", "warn", "error", "fatal"],
          "description": "Minimum log level",
          "default": "info"
        },
        "output": {
          "type": "string",
          "enum": ["console", "file", "syslog", "both"],
          "description": "Log output destination",
          "default": "console"
        },
        "file": {
          "type": "string",
          "description": "Log file path when output is 'file' or 'both'"
        },
        "maxSize": {
          "type": "integer",
          "description": "Maximum log file size in MB before rotation",
          "minimum": 1,
          "default": 10
        },
        "maxFiles": {
          "type": "integer",
          "description": "Number of rotated log files to keep",
          "minimum": 1,
          "default": 5
        },
        "pldmMessages": {
          "type": "boolean",
          "description": "Log raw PLDM message payloads (for debugging)",
          "default": false
        }
      }
    },
    "security": {
      "type": "object",
      "description": "Security configuration",
      "properties": {
        "authentication": {
          "type": "boolean",
          "description": "Require authentication for PLDM messages",
          "default": false
        },
        "encryption": {
          "type": "boolean",
          "description": "Enable message encryption",
          "default": false
        },
        "allowedEids": {
          "type": "array",
          "description": "Whitelist of allowed EIDs (empty = allow all)",
          "items": {
            "type": "integer",
            "minimum": 8,
            "maximum": 254
          },
          "default": []
        }
      }
    },
    "performance": {
      "type": "object",
      "description": "Performance tuning parameters",
      "properties": {
        "workerThreads": {
          "type": "integer",
          "description": "Number of worker threads for message processing",
          "minimum": 1,
          "default": 4
        },
        "bufferSize": {
          "type": "integer",
          "description": "Message buffer size in bytes",
          "minimum": 256,
          "default": 4096
        },
        "queueSize": {
          "type": "integer",
          "description": "Maximum message queue size",
          "minimum": 10,
          "default": 100
        }
      }
    },
    "eventService": {
      "type": "object",
      "description": "Event service integration",
      "properties": {
        "enabled": {
          "type": "boolean",
          "description": "Enable event publishing",
          "default": false
        },
        "endpoint": {
          "type": "string",
          "description": "Event service endpoint URL"
        },
        "topics": {
          "type": "array",
          "description": "Event topics to publish",
          "items": {
            "type": "string"
          },
          "default": ["pldm.sensor", "pldm.event", "pldm.alert"]
        }
      }
    }
  }
}
